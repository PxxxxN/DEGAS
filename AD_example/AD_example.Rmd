---
title: "AD_example"
author: "Travis Johnson"
date: "4/27/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load required packages
```{r}
library(DEGAS)
library(Rtsne)
library(ggplot2)
```

# Load data
```{r}
scDat = read.csv('scDat.csv',row.names=1)
scLab = read.csv('scLab.csv',row.names=1)
patDat = read.csv('patDat.csv',row.names=1)
patLab = read.csv('patLab.csv',row.names=1)
```

# Initialize DEGAS framework
```{r}
path.data = ''
path.result = ''
initDEGAS()
tmpDir = paste0(path.result, 'tmp/')
```

# Training DEGAS model
```{r}
ccModel1 = runCCMTLBag(scDat,scLab,patDat,patLab,tmpDir,'ClassClass','DenseNet',3,5)
```

# Predictions from DEGAS model
```{r}
# Predicting patient outcome in cells
# ie, predicting AD association in individual cells
scpatPreds = predClassBag(ccModel1,scDat,'pat')
colnames(scpatPreds) = colnames(patLab)
```

# Displaying single cells overlaid with AD impressions
```{r}
# Set seed and run tSNE
set.seed(1)
scDat_tsne = Rtsne(scDat)
colnames(scDat_tsne$Y) = c('tSNE1','tSNE2')
# kNN smoothing of AD association
impressions_sc_smooth = knnSmooth(scpatPreds[,"AD"],scDat_tsne$Y)
# Conversion of AD association to correlation
impressions_sc_smooth_cor = toCorrCoeff(impressions_sc_smooth)
tmp = data.frame(tSNE1=scDat_tsne$Y[,"tSNE1"],tSNE2=scDat_tsne$Y[,"tSNE2"],Dis=impressions_sc_smooth_cor,CT=fromOneHot(scLab))
p = ggplot(tmp,aes(x=tSNE1,y=tSNE2,color=Dis,shape=CT))+ geom_point() + scale_color_gradient2(low = "black",mid="lavender",high="red")
plot(p+labs(size='AD association',color='Cell type') + theme(legend.title=element_text(size=rel(1)),legend.text=element_text(size=rel(1)),axis.title=element_text(size=rel(1)),axis.text.x=element_text(size=rel(1)),axis.text.y=element_text(size=rel(1))))

```










